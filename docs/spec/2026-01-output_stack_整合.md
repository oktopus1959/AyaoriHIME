# AyaoriHIME Spec: OutputStack 整合性

## 0. 目的
- フロントとバックエンドの間の文字列のやり取りをしている OutputStack の整合性を確保して、バックエンドでの文字列候補選択の精度を上げたい

## 1. 背景

AyaoriHIME は、C# で作成されたフロント部と C++ で作成されたバックエンド部があります。
バックエンド部では、ユーザーによるキー入力に対して、それを漢字やひらがなの文字列に変換します。
ただし、1打鍵で1つの文字が生成されるとは限らず、1打鍵以上の複数打鍵に対して複数の漢字やひらがなが対応しています。
したがって、あるキーストローク列に対して一意に漢字やひらがなが決定されるわけではなく、複数の文字列候補が生成されます。
そして、複数の入力文字列候補に対して、形態素解析とNgram解析を行い、最適と思われる候補を選択して出力します。
候補は一つだけに絞り込まず、ビームサーチで常にK-bestを保持しています。
ただし、バックエンド側で保持している K-Best は、文字列長が限られており、せいぜい十数文字程度です。

フロント側では、出力された最適文字列を、編集バッファ内により長い文字列として保持しており、矢印キーやBS, Delete によってバッファ内の文字列を編集することも可能です。

次のキー入力によって、新しい文字を生成する際、フロント側から保持している編集バッファの内容をバックエンド側に送信し、バックエンドは受信した文字列と、自身が保持している K-Best 候補文字列とを突き合わせて、受信した文字列をK-Best候補文字列にうまくマージしてから、そこに新しいキー入力による候補文字をアペンドして、形態素解析とNgram解析を実行します。

このフロントとバックエンドの間の文字列のやり取りに OutputStack という文字列バッファを使用します。これは、文字とフラグを持つ構造体の配列となっており、フラグによって K-Best 候補文字列の可変部分の制御などを行っています。
ただし、現状、この OutputStack をうまく制御できておらず、ユーザーに表示されている文字列と、バックエンドが受信した文字列とに差違が生じている状況です。

## 2. ソースコード
- OutputStack は kw-uni/OutputStack.{cpp,h}
- 複数文字列候補の生成や解析は kw-uni/StrokeMerger 配下の *.cpp, *.h
- フロントの編集バッファは AyaoriHIME/Forms/FrmEditBuffer.cs
- バックエンドからフロントへの文字列送信は、kw-uni/Decoder.h の DecoderOutParams::outString を介している
- DecoderOutParams::topString で OutputStack の内容をフロントに送信しているが、現在はあまり活用されていない
- フロントからの受信文字列は、kw-uni/Decoder.cpp の HandleDeckey() で、`STATE_COMMON->SetEditBufferString(deckeyParams->editBufferData);` というところで保存

## 3. まず、やりたいこと
- EditBuffer の内容と OutputStack の内容を同期させたい
- OutputStack のフラグも活用して、バックエンド側の K-Best に格納されるべき「可変」部分の文字列を制御したい
- 形態素解析やNgram解析には、OutputStack(EditBuffer)の内容も取り込んだ長い文字列を渡して、精度を上げたい

## 4. 追加情報
- SETTINGS->useEditBuffer フラグは、UIとして編集バッファを表示しているかどうかを示しており、フロント側は内部では仮想的な編集バッファを持っており、常にその内容をバックエンドに渡してきます。
