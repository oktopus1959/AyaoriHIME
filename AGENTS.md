# AGENTS.md

## Project
- Repository: AyaoriHIME (漢織媛)
- Domain: IME / 漢字直接入力 / かな配列エミュレータ
- Language: C# / C++
- Visual Studio でビルドされます。
- 現在は TSF / COM を利用していないが、将来的には対応予定です。

## 仕様
- AyaoriHIMEは、ユーザーのキー入力を日本語に変換するためのツール
- キーストローク列をどの文字に対応させるかを定義した配列テーブルを用いる
- 配列テーブルは同時に2つ利用できる
- 1～Nストロークに対して対して自由に文字(または文字列)を定義できる
- 結果として、キーストロークに対して複数の文字列が対応することになり、そこから形態素解析やNgram解析を行って統計的に最もコストが低いものを優先的に出力する

## 前提と制約
- Windows 専用を維持する（クロスプラットフォーム化しない）
- TSF / COM のライフサイクル・スレッドモデルを厳守する
- wchar_t / UTF-16 / BSTR 前提を維持する
- 既存の設計意図と動作仕様を尊重する

## Current Task
- 「キーストロークに対して複数の文字列が対応することになり、そこから形態素解析やNgram解析を行って統計的に最もコストが低いものを優先的に出力する」機能の改善
- 実装の中心は kw-uni\StrokeMerger\ 配下

## Design Direction (Tentative)
- 複数の出力候補の中から最も尤もらしいものを選択することが求められる
- 同時に、計算時間は1ストロークごとに10msec以内に収める

## 作業方針
- 変更は最小限・局所的に行う
- 仕様変更や挙動変更は事前に合意を取る
- 文字コードと COM/TSF の契約を最優先で保護する
- docs/spec/*.md が存在する場合、それを最優先の指示として扱う
- スコープ外の変更は禁止。提案だけに留める

## 使用言語（必須）

- **すべての回答・説明・設計・コメントは日本語で行うこと**
- 英語での回答は禁止する
- コード中のコメントは日本語でも英語でも可とするが、
  設計意図・理由説明は必ず日本語で記述すること

## 許可コマンド（調査フェーズ）

調査・分析フェーズにおいて、以下のコマンドは
**事前の確認や許可を取ることなく、自由に実行してよいものとする**。

- `rg`（ripgrep）：クラス名、メソッド名、呼び出し箇所の検索
- `sed -n 'N,Mp'`：ファイルの一部分の表示
- `awk`, `head`, `tail`, `wc`, `cut`：軽量なテキスト確認
- `ls`, `tree`, `find`：ディレクトリ／ファイル構成の把握
- `git grep`, `git log`, `git blame`：履歴・責務・変更理由の確認

これらのコマンドは **標準的な調査手段であり、毎回ユーザーに確認する必要はない**。

AGENTS.d/permissions.md も参照のこと。

## コマンド使用ルール

- 推測や記憶に頼らず、上記コマンドを積極的に使用して事実を確認すること
- 調査結果を説明する際は、以下を可能な範囲で含めること
  - 使用したコマンド
  - 対象ファイル名
  - 該当行番号または行範囲
- 「〜と思われる」「〜の可能性がある」と書く場合は、その根拠となるコード箇所を必ず示すこと

## 重要：sandbox 解除確認について
- 「retry without sandbox?」は安全境界の変更に該当するため、原則ユーザー確認が必要になり得る。
- まず sandbox 内で失敗しないように、実行前に `ls` や `test -f` で存在確認を行い、
  失敗時はエラー内容（終了コード・メッセージ）を日本語で報告して原因を特定すること。

